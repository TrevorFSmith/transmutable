{% extends "peach/base.html" %}
{% load imagetags %}
{% block sub-title %}{{ namespace.display_name }} | {% endblock %}

{% block sub-head %}
<script>
window.namespace = null;
window.wikiPage = null;
window.wikiPageEditorView = null;

window.schema.on('populated', function(){
	window.namespace = new window.schema.api.peach.Namespace({'id':{{namespace.id}}});
	window.wikiPage = new window.schema.api.peach.WikiPage({'id':{{page.id}}});
	window.user = new window.schema.api.auth.User({'id':{{request.user.id}}});

	// Fetch namespace, wikiPage, and user and then call initPage
	// TODO make a thing which watches N models and calls back when they're all fetched
	window.namespace.fetch({
		'success': function(){ 
			window.wikiPage.fetch({
				'success':function(){
					window.user.fetch({
						'success': initPage
					})
				} 
			})
		}
	})

	$('#toggle-public').click(togglePublicity);
	$('#toggle-archive').click(toggleArchive);
});

function initPage(){
	//this assumes that window.namespace and window.wikiPage are populated
	window.wikiPageEditorView = new peach.views.WikiPageEditorView({
		'model':window.wikiPage,
		'namespace':window.namespace,
		'user':window.user
	});
	$('#main-column').append(window.wikiPageEditorView.el);
}

function togglePublicity(){
}

function toggleArchive(){
}
</script>
{% endblock %}

{% block content %}
<div class="row-fluid">
	<div id="left-column" class="span2">
		<ul class="breadcrumb">
			<li>Pages</li>
		</ul>
		<ul>
		   <li><a title="SplashPage" href="{{ page.namespace.splash_page.get_absolute_url }}">SplashPage</a></li>
			{% for page in namespace.pages.all %}
				{% if page.name != 'SplashPage' %}
				   <li><a title="{{ page.name }}" href="{{ page.get_absolute_url }}">{{ page.name }}</a></li>
				{% endif %}
			{% endfor %}
		</ul>

		{% if google_ad_settings.namespace_left %}
			<script type="text/javascript"><!--
				google_ad_client = "{{ google_ad_settings.namespace_left.ad_client }}";
				google_ad_slot = "{{ google_ad_settings.namespace_left.ad_slot }}";
				google_ad_width = 160;
				google_ad_height = 600;
			//-->
			</script>
			<script type="text/javascript" src="https://pagead2.googlesyndication.com/pagead/show_ads.js"></script>
		{% endif %}

	</div>
	<div id="main-column" class="span10">
		<ul class="breadcrumb">
			{% if page.namespace.owner == request.user %}
			<li>
				<a href="{% url peach.views.index %}">Notes</a> <span class="divider">/</span>
			</li>
			{% endif %}			
			<li class="active">
				{{ namespace.display_name }}
				{% if namespace.owner == request.user %}
					<a href="#toggle-public">
						{% if page.namespace.public %}
							<i class="icon-unlock"></i>
						{% else %}
							<i class="icon-lock"></i>
						{% endif %}
					</a>
					<a href="#toggle-archive">
						{% if page.namespace.archived %}
							<i class="icon-folder-close-alt"></i>
						{% else %}
							<i class="icon-folder-open-alt"></i>
						{% endif %}
					</a>
				{% endif %}
			</li>
		</ul>
	</div>
</div>
{% endblock %}